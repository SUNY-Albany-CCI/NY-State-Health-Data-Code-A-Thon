var http = require('http');

module.exports = {

  onSocketMessage: function(ewd) {
    var wsMsg = ewd.webSocketMessage;
    var type = wsMsg.type;
    var params = wsMsg.params;
    var sessid = ewd.session.$('ewd_sessid')._value;

    NYSDatacallback = function(response) {
      var dataNYState = '';

      response.on('data', function (chunk) {
        dataNYState += chunk;
      });

      response.on('end', function () {
        console.log(dataNYState);

        var savedMsg = new ewd.mumps.GlobalNode('%NYStateDataTest', []);
        savedMsg._setDocument(dataNYState);
        ewd.log('*** NYSDATA Incoming Web Socket message received: ' + JSON.stringify(dataNYState, null, 2), 1);

      });
    }

    if (type === 'sendHelloWorld') {
      var savedMsg = new ewd.mumps.GlobalNode('%AMessage', []);
      savedMsg._setDocument(wsMsg);
      ewd.log('*** Incoming Web Socket message received: ' + JSON.stringify(wsMsg, null, 2), 1);
      return {savedInto: '%AMessage'};
    }

    if (type === 'getHelloWorld') {
      var savedMsg = new ewd.mumps.GlobalNode('%AMessage', []);
      return savedMsg._getDocument();
    }

    if (type === 'queryNYStateData') {

      var NYSDataURI = {
        host: 'health.data.ny.gov',
        path: '/resource/child-and-adult-care-food-program-participation-beginning-2007.json?'
      };

      http.request(NYSDataURI, NYSDatacallback).end();

      return {requestToNYSData: 'Request sent to health.data.ny.gov'};
    }

    if (type === 'getNYStateData') {
      var savedMsg = new ewd.mumps.GlobalNode('%NYStateDataTest', []);
      return savedMsg._getDocument();
    }


  }
};

